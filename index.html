<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteCyborg</title>
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js" charset="utf-8"></script>
</head>

<body>
    <div id="dropzone" style="background-color:red;height:100px;width:100px;">
    </div>
    <div id="plot" style="width:600px;height:600px;"></div>
    <script>
        // Add a drag & drop event listener on body and read the content of the csv file in pure javascript
        document.getElementById('dropzone').addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            var files = e.dataTransfer.files;
            var file = files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                var text = reader.result;
                let lines = text.split(/\r?\n/);
                lines = lines.map(line => line.split(';'));
                // Le fichier peut contenir des colonnes additionnelles (classe, etc.), il faut les gérer.
                // Trouvons la colonne moyenne pour gérer ces colonnes aditionnelles
                let colMoyenne = lines[1].indexOf('Moyenne');
                let datesEvals = lines[0].slice(colMoyenne + 1);
                let infosEvals = lines[1].slice(colMoyenne + 1);
                infosEvals = infosEvals.map((x, i) => {
                    x = x.split('-/');
                    if (x.length == 1) {
                        return {
                            max: 20,
                            coeff: x[0],
                            date: datesEvals[i]
                        };
                    } else {
                        return {
                            max: x[0],
                            coeff: x[1],
                            date: datesEvals[i]
                        };
                    }
                });
                let eleves = lines.slice(2).map(line => line[0].replaceAll('"', ''));
                eleves.pop(); // On enlève la dernière ligne qui contient les moyennes de classe
                let notes = lines.slice(2).map(line => line.slice(colMoyenne + 1));
                // Nous allons transposer notes
                notes = notes[0].map((col, i) => notes.map(row => row[i]));
                // On nettoie les notes
                notes = notes.map(
                    x => (x.map(
                        y => {
                            y = y.replaceAll('"', '').replaceAll(',', '.');
                            let f = parseFloat(y);
                            if (f.toString() === y) {
                                return f; // On a un nombre
                            } else {
                                return y; // On a du texte (abs, etc.)
                            }
                        })
                    )
                );
                console.log(notes);
                console.log(infosEvals);
                console.log(eleves);
            }
            reader.readAsText(file);
        });

        document.getElementById('dropzone').addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        notes = [38, 28.75, 23.5, 15.75, 28.25, 13.25, 33, 30, 31.5, 33.75, 12.5, 25, 34.75, 26.25, 27.5, 18.75, 28.5, 21.5, 26, 22.25, 12.25, 33, 30.5, 14.37, 33.25]
        notes2 = [88, 63, 89, 90, 87, 53, 85, 90, 88, 89, 86, 82, 90, 56, 32, 44, 86, 57, 90, 89, 87, 90, 83, 34, 90]

        // create Boxplot

        var trace1 = {
            x: Array(notes.length).fill(0),
            y: notes,
            type: 'box',
            name: 'All Students',
            boxpoints: 'all',
            jitter: 0.5,
            whiskerwidth: 0.2,
            fillcolor: 'cls',
            marker: { size: 2, color: 'hsl(220, 100%, 75%)' },
            line: { width: 1 },
            width: 0.5,
            pointpos: 0
        };

        var trace2 = {
            x: Array(notes2.length).fill(1),
            y: notes2,
            type: 'box',
            name: 'All Students',
            boxpoints: 'all',
            jitter: 0.5,
            whiskerwidth: 0.2,
            fillcolor: 'cls',
            marker: { size: 2, color: 'hsl(220, 100%, 50%)' },
            line: { width: 1 },
            width: 0.5,
            pointpos: 0,
        };

        var trace3 = {
            x: [0, 1],
            y: [25, 70],
            type: 'scatter',
            mode: 'none',
            error_x: {
                type: 'constant',
                value: 0.25,
                color: 'red'
            }
        };

        var data = [trace1, trace2, trace3];


        var layout = {
            title: 'Box Plot',
            yaxis: {
                zeroline: false
            }
        };

        Plotly.newPlot('plot', data, layout);

    </script>
</body>

</html>